<UserControl x:Class="BudgetTracker.Wpf.Net8.Views.TransactionsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:BudgetTracker.Wpf.Net8.ViewModels"
             xmlns:behaviors="clr-namespace:BudgetTracker.Wpf.Net8.Behaviors"
             mc:Ignorable="d"
             d:DesignHeight="450" d:DesignWidth="900">

    <!-- If you already set DataContext elsewhere, remove this line -->
    <UserControl.DataContext>
        <vm:TransactionsViewModel />
    </UserControl.DataContext>

    <DockPanel Margin="12">

        <!-- Top bar: Filters + Buttons -->
        <Border DockPanel.Dock="Top"
                Padding="10"
                CornerRadius="8"
                BorderBrush="{DynamicResource {x:Static SystemColors.ControlDarkBrushKey}}"
                BorderThickness="1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- Filters -->
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,12,0">
                    <TextBlock Text="Year:" VerticalAlignment="Center" Margin="0,0,6,0"/>
                    <ComboBox Width="90"
                              ItemsSource="{Binding Years}"
                              SelectedItem="{Binding SelectedYear}"
                              Margin="0,0,16,0"/>

                    <TextBlock Text="Month:" VerticalAlignment="Center" Margin="0,0,6,0"/>
                    <ComboBox Width="140"
                              ItemsSource="{Binding Months}"
                              SelectedItem="{Binding SelectedMonth}"
                              DisplayMemberPath="Display"
                              Margin="0,0,16,0"/>

                    <TextBlock Text="Category:" VerticalAlignment="Center" Margin="0,0,6,0"/>
                    <ComboBox Width="200"
                              ItemsSource="{Binding Categories}"
                              SelectedItem="{Binding SelectedCategory}"
                              DisplayMemberPath="Name"
                              Margin="0,0,16,0"/>

                    <Button Content="Clear Filters"
                            Command="{Binding ClearFiltersCommand}"
                            Padding="10,4"/>
                </StackPanel>

                <!-- Buttons -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                    <Button Content="Refresh" Command="{Binding RefreshCommand}" Padding="10,4" Margin="0,0,8,0"/>
                    <Button Content="Add" Command="{Binding AddTransactionCommand}" Padding="10,4" Margin="0,0,8,0"/>
                    <Button Content="Edit (Dialog)" Command="{Binding EditSelectedCommand}" Padding="10,4" Margin="0,0,8,0"/>
                    <Button Content="Delete Selected" Command="{Binding DeleteSelectedCommand}" Padding="10,4"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Data Grid (INLINE EDIT ENABLED) -->
        <DataGrid Margin="0,12,0,0"
                  ItemsSource="{Binding Transactions}"
                  SelectedItem="{Binding SelectedTransaction, Mode=TwoWay}"
                  behaviors:DataGridSelectedItemsBehavior.SelectedItems="{Binding SelectedTransactions, Mode=TwoWay}"
                  AutoGenerateColumns="False"
                  CanUserAddRows="False"
                  IsReadOnly="False"
                  SelectionMode="Extended"
                  SelectionUnit="FullRow"
                  RowEditEnding="TransactionsGrid_RowEditEnding"
                  PreviewKeyDown="TransactionsGrid_PreviewKeyDown">

            <DataGrid.Columns>

                <!-- Id is read-only -->
                <DataGridTextColumn Header="Id"
                                    Binding="{Binding Id}"
                                    IsReadOnly="True"
                                    Width="60" />

                <!-- Date (DatePicker editor) -->
                <DataGridTemplateColumn Header="Date" Width="140">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding Date, StringFormat={}{0:yyyy-MM-dd}}"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>

                    <DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <DatePicker SelectedDate="{Binding Date, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                        SelectedDateFormat="Short"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellEditingTemplate>
                </DataGridTemplateColumn>

                <!-- Type (ComboBox editor) -->
                <DataGridTemplateColumn Header="Type" Width="120">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding Type}"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>

                    <DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <ComboBox SelectedItem="{Binding Type, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                <ComboBoxItem Content="Expense"/>
                                <ComboBoxItem Content="Income"/>
                            </ComboBox>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellEditingTemplate>
                </DataGridTemplateColumn>

                <!-- Category (ComboBox editor, writes CategoryId) -->
                <DataGridTemplateColumn Header="Category" Width="220">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding Category}"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>

                    <DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <ComboBox ItemsSource="{Binding DataContext.EditableCategories, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                      DisplayMemberPath="Name"
                                      SelectedValuePath="Id"
                                      SelectedValue="{Binding CategoryId, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellEditingTemplate>
                </DataGridTemplateColumn>

                <!-- Description -->
                <DataGridTextColumn Header="Description"
                                    Binding="{Binding Description, Mode=TwoWay, UpdateSourceTrigger=LostFocus}"
                                    Width="*" />

                <!-- Amount -->
                <DataGridTextColumn Header="Amount"
                                    Binding="{Binding Amount, Mode=TwoWay, UpdateSourceTrigger=LostFocus, StringFormat={}{0:0.00}}"
                                    Width="120" />

            </DataGrid.Columns>
        </DataGrid>

        <TextBlock DockPanel.Dock="Bottom"
                   Margin="2,8,0,0"
                   Opacity="0.7"
                   Text="Tip: You can edit cells directly. Press Enter to commit a row. Hold Ctrl/Shift to multi-select for delete."/>
    </DockPanel>
</UserControl>
